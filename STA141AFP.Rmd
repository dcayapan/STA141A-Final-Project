---
title: "STA141A Final Project"
author: "Daniel Cayapan"
date: "`r Sys.Date()`"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/Users/danie/Downloads/')
```
Datasets For 2022-2023 Season
```{r}
nba <- read.csv("nba_salaries.csv")
print(head(nba))

nba1 <- read.csv("NBAWL.csv")
print(head(nba1))

nba2 <- read.csv("NBAData1.csv")
print(head(nba2))
```
Merge the three data sets
```{r}
library(dplyr)

merged_nba_full <- full_join(nba, nba2, by = "Team")
print(head(merged_nba_full)) # print out first couple rows

merged_nba_full <-full_join(merged_nba_full, nba1, by = "Team")
print(head(merged_nba_full))
```
Cleaning Data: IF NA salary due to player playing for multiple teams, just omit entire player. Also delete overlapping columns between datasets that has inaccurate or data that is not needed for this analysis.
```{r}
library(tidyr)

merged_nba_clean <- drop_na(merged_nba_full)


merged_nba_clean <- subset(merged_nba_clean, select = -c(Rank, RPI, W, L, PCT, SOS, PWR, Player.additional, PF.y, PA, Signed))
merged_nba_clean <- drop_na(merged_nba_clean)

print(head(merged_nba_clean))
```
First we will do correlation between individual player salaries and their teams' win percentage without clustering to see the default results.
```{r}
library(ggplot2)

correlation1 <- cor(merged_nba_clean$Salary, merged_nba_clean$WP)


print(paste("Correlation between individual salary and team win percentage:", correlation1))

# Plot the relationship between individual salary and team win percentage
ggplot(merged_nba_clean, aes(x = Salary, y = WP)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Correlation between Individual Salary and Team Win Percentage",
       x = "Individual Salary",
       y = "Win Percentage") +
  theme_minimal()
```

Now we will cluster by player salaries
```{r}
# load necessary libraries
library(dplyr)
library(ggplot2)
library(factoextra)

# Select the salary column
salary_data <- merged_nba_clean %>% select(Salary)

# Normalize the salary data
salary_data <- scale(salary_data)

# Elbow method to find the optimal number of clusters(as researched)
fviz_nbclust(salary_data, kmeans, method = "wss") +
  geom_vline(xintercept = 3, linetype = 2) +
  labs(subtitle = "Elbow method")

# Set seed for reproducibility
set.seed(123)

# Apply K-means clustering
kmeans_result <- kmeans(salary_data, centers = 3, nstart = 25)

# Add cluster assignment to the original dataset
merged_nba_clean$cluster <- kmeans_result$cluster

# Plot the clusters
ggplot(merged_nba_clean, aes(x = Salary, y = Salary, color = factor(cluster))) +
  geom_point() +
  labs(title = "K-means Clustering of Players by Salary",
       x = "Salary",
       y = "Salary",
       color = "Cluster") +
  theme_minimal()

```
```{r}
# Count the number of players in each cluster
cluster_counts <- merged_nba_clean %>%
  group_by(cluster) %>%
  summarise(count = n())

print(cluster_counts)
```
Correlation between individual player salaries and their teams' win percentage with clustering to see more reliable results.
```{r}
# Calculate average salary per cluster
cluster_stat <- merged_nba_clean %>%
  group_by(cluster) %>%
  summarise(mean_salary = mean(Salary), mean_WP = mean(WP))

print(cluster_stat)

# Calculate the correlation between mean spending and mean WP for clusters
correlation_cluster_salary_WP <- cor(cluster_stat$mean_salary, cluster_stat$mean_WP)

print(paste("Correlation between cluster mean salary and win percentage:", correlation_cluster_salary_WP))
```
Next we will see correlation between average team spending and win percentage without clustering.
```{r}
library(ggplot2)

# Step 3: Calculate the correlation
correlation2 <- cor(merged_nba_clean$Total, merged_nba_clean$WP)

# Step 4: Print the correlation
print(paste("Correlation between Average Team Spending and Win Percentage Without Clustering:", correlation2))

# Step 5: Plot the relationship between spending and win percentage
ggplot(merged_nba_clean, aes(x = Total, y = WP)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  labs(title = "Correlation between Team Spending and Win Percentage",
       x = "Average Team Spending",
       y = "Win Percentage") +
  theme_minimal()

```
Cluster by Team Spending
```{r}
# load necessary libraries
library(dplyr)
library(ggplot2)
library(factoextra)

# Select the Total column
Total_data <- merged_nba_clean %>% select(Total)

# Normalize the Total data
Total_data <- scale(Total_data)

# Elbow method to find the optimal number of clusters(as researched)
fviz_nbclust(Total_data, kmeans, method = "wss") +
  geom_vline(xintercept = 3, linetype = 2) +
  labs(subtitle = "Elbow method")

# Set seed for reproducibility
set.seed(23)

# Apply K-means clustering
kmeans_result1 <- kmeans(Total_data, centers = 3, nstart = 25)

# Add cluster assignment to the original dataset
merged_nba_clean$cluster1 <- kmeans_result1$cluster

# Plot the clusters
ggplot(merged_nba_clean, aes(x = Total, y = Total, color = factor(cluster1))) +
  geom_point() +
  labs(title = "K-means Clustering of Players by Team Spending",
       x = "Total",
       y = "Total",
       color = "Cluster") +
  theme_minimal()

```



We will now find correlation between average team spending and win percentage with clustering.
```{r}
# Calculate the mean salary and WP for each cluster
cluster_stats <- merged_nba_clean %>%
  group_by(cluster1) %>%
  summarise(mean_spending = mean(Total), mean_WP = mean(WP))

print(cluster_stats)

# Calculate the correlation between mean spending and mean WP for clusters
correlation_cluster_spending_WP <- cor(cluster_stats$mean_spending, cluster_stats$mean_WP)

print(paste("Correlation between cluster mean salary and win percentage:", correlation_cluster_spending_WP))
```





